name: SonarQube

on:
  workflow_run:
    workflows: ["Test"]
    types: [completed]

concurrency:
  group: sonar-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

jobs:
  sonarqube:
    name: SonarQube Scan
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: [self-hosted, sonar]
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
      statuses: write
    steps:
      - uses: actions/checkout@v6
        with:
          repository: ${{ github.event.workflow_run.head_repository.full_name }}
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Get PR info
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.workflow_run.pull_requests?.[0];
            if (pr) {
              core.setOutput('is_pr', 'true');
              core.setOutput('pr_number', pr.number.toString());
              core.setOutput('pr_branch', '${{ github.event.workflow_run.head_branch }}');
              core.setOutput('pr_base', pr.base.ref);
            } else {
              core.setOutput('is_pr', 'false');
            }

      - name: Download backend coverage shards
        uses: actions/download-artifact@v4
        continue-on-error: true
        id: backend-coverage
        with:
          pattern: backend-coverage-*
          path: backend/
          merge-multiple: true
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download frontend coverage
        uses: actions/download-artifact@v4
        continue-on-error: true
        id: frontend-coverage
        with:
          name: frontend-coverage
          path: frontend/coverage/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Merge backend coverage
        working-directory: backend
        run: |
          if ls coverage-shard*.xml 1>/dev/null 2>&1; then
            python3 ../scripts/merge_coverage.py
          else
            echo "No backend coverage shards found, creating empty coverage"
            echo '<?xml version="1.0" ?><coverage version="6" lines-valid="0" lines-covered="0" line-rate="0" branches-covered="0" branches-valid="0" branch-rate="0" timestamp="0" complexity="0"><sources><source>backend/app</source></sources><packages></packages></coverage>' > coverage.xml
          fi

      - name: Ensure frontend coverage exists
        run: |
          mkdir -p frontend/coverage
          if [ ! -f frontend/coverage/lcov.info ]; then
            echo "TN:" > frontend/coverage/lcov.info
          fi

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v7
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            ${{ steps.pr-info.outputs.is_pr == 'true' && format('-Dsonar.pullrequest.key={0} -Dsonar.pullrequest.branch={1} -Dsonar.pullrequest.base={2}', steps.pr-info.outputs.pr_number, steps.pr-info.outputs.pr_branch, steps.pr-info.outputs.pr_base) || '' }}

      - name: SonarQube Quality Gate
        id: quality-gate
        uses: sonarsource/sonarqube-quality-gate-action@v1
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: Post commit status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const sha = '${{ github.event.workflow_run.head_sha }}';
            const gate = '${{ steps.quality-gate.outcome }}';
            let state, description;
            if (gate === 'success') {
              state = 'success';
              description = 'Quality gate passed';
            } else if (gate === 'failure') {
              state = 'failure';
              description = 'Quality gate failed';
            } else {
              state = 'error';
              description = 'Quality gate check did not complete';
            }
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: sha,
              state: state,
              target_url: runUrl,
              description: description,
              context: 'SonarQube Quality Gate'
            });
