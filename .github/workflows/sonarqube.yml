name: SonarQube

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: sonar-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  sonarqube:
    name: SonarQube Scan
    if: github.event_name == 'push' || github.event.pull_request.head.repo.fork == false
    runs-on: [self-hosted, sonar]
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # Wait for Test workflow to finish and find its run ID
      - name: Wait for Test workflow
        id: wait-test
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.sha;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Poll for up to 15 minutes
            for (let i = 0; i < 30; i++) {
              const runs = await github.rest.actions.listWorkflowRunsForRepo({
                owner, repo,
                head_sha: sha,
                status: 'completed',
                per_page: 10
              });

              const testRun = runs.data.workflow_runs.find(r =>
                r.name === 'Test' && r.conclusion === 'success'
              );

              if (testRun) {
                core.setOutput('run_id', testRun.id);
                console.log(`Found Test run: ${testRun.id}`);
                return;
              }

              console.log(`Waiting for Test workflow... (attempt ${i + 1}/30)`);
              await new Promise(r => setTimeout(r, 30000));
            }
            core.setFailed('Test workflow did not complete in time');

      - name: Download merged backend coverage
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage-merged
          path: backend/
          run-id: ${{ steps.wait-test.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download frontend coverage
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/
          run-id: ${{ steps.wait-test.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - uses: sonarsource/sonarqube-scan-action@v7
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - uses: sonarsource/sonarqube-quality-gate-action@v1
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
